{% extends 'base.html.twig' %}

{% block title %}Catálogo — Ferretería Q10{% endblock %}

{% block body %}
	{# ── Hero ─────────────────────────────────────────────────────────── #}
	<section class="hero-section" aria-label="Bienvenida">
		<div class="container position-relative">
			<h1 class="display-5 fw-bold mb-3">
				<i class="bi bi-hammer me-2" aria-hidden="true"></i>Tu Ferretería de Confianza
			</h1>
			<p class="lead mb-4 mx-auto" style="max-width:600px;">
				Encuentra las mejores herramientas y materiales para tus proyectos profesionales y del hogar.
			</p>

			{# ── Buscador ────────────────────────────────────────────── #}
			<form action="{{ path('catalog_index') }}" method="GET" role="search" aria-label="Buscar productos" class="mx-auto" style="max-width:500px;">
				<div class="input-group input-group-lg shadow">
					<label for="search-input" class="visually-hidden">Buscar productos</label>
					<input type="search" id="search-input" name="q" class="form-control border-0" placeholder="Buscar productos…" value="{{ query }}" aria-label="Término de búsqueda">
					<button class="btn btn-ferr px-4" type="submit" aria-label="Buscar">
						<i class="bi bi-search" aria-hidden="true"></i>
					</button>
				</div>
			</form>
		</div>
	</section>

	{# ── Catálogo ─────────────────────────────────────────────────────── #}
	<section class="container py-5" aria-label="Catálogo de productos">

		{% if query %}
			<div class="d-flex justify-content-between align-items-center mb-4">
				<h2 class="h4 mb-0">
					Resultados para "<strong>{{ query }}</strong>"
					<span class="badge bg-secondary ms-2">{{ productos|length }}</span>
				</h2>
				<a href="{{ path('catalog_index') }}" class="btn btn-outline-secondary btn-sm">
					<i class="bi bi-x-lg me-1" aria-hidden="true"></i>Limpiar búsqueda
				</a>
			</div>
		{% else %}
			<h2 class="h4 mb-4">
				<i class="bi bi-grid me-2 text-warning" aria-hidden="true"></i>Todos los productos
			</h2>
		{% endif %}

		{% if productos is empty %}
			<div class="text-center py-5">
				<i class="bi bi-inbox display-1 text-muted" aria-hidden="true"></i>
				<p class="mt-3 text-muted fs-5">No se encontraron productos.</p>
				{% if query %}
					<a href="{{ path('catalog_index') }}" class="btn btn-ferr mt-2">Ver todos los productos</a>
				{% endif %}
			</div>
		{% else %}

			<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-4 g-4">
				{% for producto in productos %}
					<div class="col">
						<article class="card card-producto h-100">
							{# Imagen #}
							<div class="position-relative">
								{% if producto.imagen %}
									<img src="{{ asset('uploads/productos/' ~ producto.imagen) }}" class="card-img-top" alt="Imagen de {{ producto.nombre }}" loading="lazy">
								{% else %}
									<div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height:220px;" role="img" aria-label="Sin imagen disponible">
										<i class="bi bi-image text-muted" style="font-size:3rem;" aria-hidden="true"></i>
									</div>
								{% endif %}

								{# Badge stock #}
								{% if producto.stock > 0 %}
									<span class="badge bg-success badge-stock">En stock ({{ producto.stock }})</span>
								{% else %}
									<span class="badge bg-danger badge-stock">Agotado</span>
								{% endif %}
							</div>

							<div class="card-body d-flex flex-column">
								<h3 class="card-title h6 fw-bold">{{ producto.nombre }}</h3>
								<p class="card-text text-muted small flex-grow-1">
									{{ producto.descripcion|length > 100
                                        ? producto.descripcion|slice(0, 100) ~ '…'
                                        : producto.descripcion }}
								</p>
								<p class="fw-bold fs-5 text-warning mb-3">{{ producto.precio|number_format(2, ',', '.') }} €</p>

								<div class="d-flex gap-2 mt-auto">
									<a href="{{ path('catalog_show', {id: producto.id}) }}" class="btn btn-outline-secondary btn-sm flex-grow-1" aria-label="Ver detalles de {{ producto.nombre }}">
										<i class="bi bi-eye me-1" aria-hidden="true"></i>Ver
									</a>
									{% if producto.stock > 0 %}
										<button type="button"
										        class="btn btn-ferr btn-sm flex-grow-1"
										        data-bs-toggle="modal"
										        data-bs-target="#addCartModal{{ producto.id }}"
										        aria-label="Añadir {{ producto.nombre }} al carrito">
											<i class="bi bi-cart-plus me-1" aria-hidden="true"></i>Añadir
										</button>
									{% else %}
										<button class="btn btn-secondary btn-sm flex-grow-1" disabled>
											<i class="bi bi-cart-x me-1" aria-hidden="true"></i>Agotado
										</button>
									{% endif %}
								</div>
							</div>
						</article>
					</div>
				{% endfor %}
			</div>

			{# ── Modales de "Añadir al carrito" con selector de cantidad ── #}
			{% for producto in productos %}
				{% if producto.stock > 0 %}
				<div class="modal fade" id="addCartModal{{ producto.id }}" tabindex="-1" aria-labelledby="addCartModalLabel{{ producto.id }}" aria-hidden="true">
					<div class="modal-dialog modal-dialog-centered modal-sm">
						<div class="modal-content">
							<div class="modal-header" style="background: linear-gradient(135deg, var(--ferr-secondary), var(--ferr-dark)); color: #fff;">
								<h5 class="modal-title" id="addCartModalLabel{{ producto.id }}">
									<i class="bi bi-cart-plus me-2"></i>Añadir al carrito
								</h5>
								<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
							</div>
							<form action="{{ path('cart_add', {id: producto.id}) }}" method="POST">
								<div class="modal-body text-center">
									<p class="fw-semibold mb-3">{{ producto.nombre }}</p>
									<p class="text-warning fw-bold fs-5 mb-3">{{ producto.precio|number_format(2, ',', '.') }} €</p>

									<label for="qty-{{ producto.id }}" class="form-label fw-semibold">Cantidad</label>
									<div class="d-flex align-items-center justify-content-center gap-2 mb-2">
										<button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeQty({{ producto.id }}, -1)" aria-label="Reducir cantidad">
											<i class="bi bi-dash-lg"></i>
										</button>
										<input type="number" id="qty-{{ producto.id }}" name="quantity"
										       class="form-control text-center fw-bold" style="width: 70px;"
										       value="1" min="1" max="{{ producto.stock }}"
										       aria-label="Cantidad a añadir">
										<button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeQty({{ producto.id }}, 1)" aria-label="Aumentar cantidad">
											<i class="bi bi-plus-lg"></i>
										</button>
									</div>
									<small class="text-muted">Disponible: {{ producto.stock }} uds.</small>
								</div>
								<div class="modal-footer justify-content-center border-0 pt-0">
									<button type="submit" class="btn btn-ferr px-4">
										<i class="bi bi-cart-check me-1"></i>Confirmar
									</button>
								</div>
							</form>
						</div>
					</div>
				</div>
				{% endif %}
			{% endfor %}

		{% endif %}
	</section>
{% endblock %}

{% block javascripts %}
<script>
function changeQty(productId, delta) {
    var input = document.getElementById('qty-' + productId);
    var newVal = parseInt(input.value) + delta;
    var min = parseInt(input.min);
    var max = parseInt(input.max);
    if (newVal >= min && newVal <= max) {
        input.value = newVal;
    }
}
</script>
{% endblock %}
